# Define cache path and zones
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=manualmind_cache:10m max_size=100m inactive=60m use_temp_path=off;

upstream manualmind_backend {
    server manualmind:8000;
}

upstream mcp_backend {
    server manualmind-mcp-server:8001;
}

server {
    listen 80;
    #server_name manualmind.domain-tbd.com;

    # Redirect HTTP to HTTPS
 #   return 301 https://$server_name$request_uri;
#}

#server {
    #listen 443 ssl http2;
    #server_name manualmind.domain-tbd.com;

    # SSL configuration (when you get certs)
    # ssl_certificate /path/to/cert.pem;
    # ssl_certificate_key /path/to/private.key;

    # Static files
    location /static/ {
        alias /var/www/static/;
        expires 30d;
        add_header Cache-Control "public, no-transform";
    }

    # MCP Server endpoints
    location /mcp/ {
        proxy_pass http://mcp_backend/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Forward API keys and authorization headers
        proxy_pass_request_headers on;
        proxy_set_header X-API-Key $http_x_api_key;
        proxy_set_header Authorization $http_authorization;
        
        # Timeout settings for MCP operations
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Query endpoint with caching
    location /query {
        proxy_pass http://manualmind_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Enable caching for query responses
        proxy_cache manualmind_cache;
        proxy_cache_key "$request_method$request_uri$request_body";
        proxy_cache_valid 200 60s;  # Cache successful responses for 60 seconds
        proxy_cache_use_stale error timeout invalid_header updating http_500 http_502 http_503 http_504;
        proxy_cache_revalidate on;
        proxy_cache_lock on;
        
        # Add cache status headers for debugging
        add_header X-Cache-Status $upstream_cache_status;
        
        # Ensure POST requests are cached
        proxy_cache_methods GET HEAD POST;
    }

    # Other API endpoints (no caching for non-query endpoints)
    location / {
        proxy_pass http://manualmind_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket support (if needed)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}